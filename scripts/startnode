#!/bin/bash

export DISPLAY=:1
SESSNAME="qemucon"
SESSPATH="/dos/runimages/$SESSNAME"

set -e
set -x

mksessimg /dos/baseimages/freedos-c-net.qcow2.gz "$SESSNAME"

waitfordaemon vncserver true
waitfordaemon smbd true
waitfordaemon nmbd true

set +e
qemu-system-i386 -localtime \
   "$SESSPATH/c.qcow2" -boot c \
   -hdb "fat:$SESSPATH/drive_d" \
   -net nic,model=pcnet -net user \
   -name "$SESSNAME" -vnc :2
   # -chardev socket,id=com1,host=localhost,port=7000 -device isa-serial,chardev=com1
RETCODE="$?"
rm -r "$SESSPATH"
exit "$RETCODE"

# Load up FOSSIL
echo "y:" >> /dos/dosbox.conf
echo "cd \\adf" >> /dos/dosbox.conf
echo "call adfcom1" >> /dos/dosbox.conf
